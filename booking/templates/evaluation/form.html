{% extends "index.html" %}
{% load staticfiles %}
{% load booking_tags %}
{% load i18n %}

{% block htmltitle %} - {% if object.pk %}{% trans "Redigér evaluering" %}{% else %}{% trans "Opret evaluering" %}{% endif %}{% endblock %}

{% block content %}

    {% include 'common/breadcrumbrow.html' %}

    <h1>{% if object.pk %}{% trans "Redigér evaluering" %}{% else %}{% trans "Opret evaluering" %}{% endif %}</h1>

    {% verbatim %}
    <p>
        For hvert besøg udsendes et link til et evalueringsskema. Skemaet forudfyldes med værdier som defineres her.
        Ved udsendelse trækkes data ind fra besøget og gæsten: F.eks. vil {{ guest.full_name }} erstattes med gæstens fulde navn.
    </p>
    {% endverbatim %}

    <form id="evaluationform" action="" class="form-horizontal clearfix" method="post" enctype="multipart/form-data">

        {% csrf_token %}
        {{ form.non_field_errors }}

        <table class="table">
            <tr><td>
                <div class="row form-group">
                    <div class="col-sm-1">
                        <label for="presetSelector">{% trans 'Type:' %}</label>
                    </div>
                    <div class="col-sm-8">
                        <select id="presetSelector" class="form-control input-sm"></select>
                    </div>
                </div>
            </td></tr>
            <tr><td>
                <div id="fieldContainer"></div>
            </td></tr>
            <tr><td>
                <div class="row form-group">
                    <div class="col-sm-2">
                        <label for="extrafields">{% trans 'Ekstra felter:' %}</label>
                    </div>
                    <div class="col-sm-7">
                        <textarea id="extrafields" style="width:100%; min-height:8em; resize:none"></textarea>
                    </div>
                    <div class="col-sm-3">
                        {% trans 'Ekstra URL-parametre, f.eks.:' %}<br>
                        <code>foo=bar</code><br/>
                        <code>version=42</code><br/>
                        {% trans 'Linjeskift erstattes af & i resultatet' %}
                    </div>
                </div>
            </td></tr>
            <tr><td>
                {% include 'common/fields/generic_field.html' with field=form.url %}
            </td></tr>
        </table>
        {{ form.secondary }}
        {% include 'common/save_cancel.html' %}
    </form>

{% endblock %}

{% block extra_scripts %}
    <script type="text/javascript">

        var urlField = $("#{{ form.url.id_for_label }}");
        var urlBase = "http://survey-xact.dk/LinkCollector";
        var defaultLabel = "{% trans 'Brug standard' %}";
        var presetSelector = $("#presetSelector");
        var original = {};
        try {
            var originalFields = urlField.val().split("?", 2)[1].split("&");
            for (var i=0; i<originalFields.length; i++) {
                var v = originalFields[i].split("=", 2);
                original[v[0]] = v[1];
            }
        } catch (e) {}

        var presets = [
            {
                'label': '{% trans "Skoletjenesten" %}',
                'keys': ['key', 'tname', 'email', 'uv', 'uname', 'of', 'oename', 'bd', 'kt']
            },
            {
                'label': '{% trans "Gymnasieelever" %}',
                'keys': ['key', 'bd', 'ofn1', 'ofn2', 'ofv1', 'ofv2', 'agn', 'agv', 'rgn', 'opl', 'rv', 'kt']
            },
            {
                'label': '{% trans "Gymnasielærere" %}',
                'keys': ['key', 'tname', 'email', 'bd', 'ofn1', 'ofn2', 'ofv1', 'ofv2', 'agn', 'agv', 'rgn', 'opl', 'rv', 'kt']
            }
        ];

        var formDefinition = {
            'key': {},
            'tname': {
                'text': '{% trans "Gæstens navn" %}',
                'default': '{% verbatim %}{{ guest.full_name }}{% endverbatim %}'
            },
            'email': {
                'text': '{% trans "Gæstens email-adresse" %}',
                'default': '{% verbatim %}{{ guest.email }}{% endverbatim %}'
            },
            'uname': {
                'text': '{% trans "Underviserens navn" %}',
                'default': '{% verbatim %}{{ visit.assigned_teachers.first.get_full_name|default:"" }}{% endverbatim %}'
            },
            'uv': {
                'text': '{% trans "Underviser" %}',
                'default': '{% verbatim %}{{ visit.assigned_teachers.first.get_full_name|default:"" }}{% endverbatim %}'
            },
            'of': {},
            'oename': {
                'default': '{% verbatim %}{{ visit.display_title }}{% endverbatim %}'
            },
            'bd': {
                'text': '{% trans "Besøgsdag" %}',
                'default': '{% verbatim %}{{ visit.start_datetime|date:"j F" }}{% endverbatim %}'
            },
            'ofn1': {
                'text': '{% trans "Øvelse/foredrag navn" %}',
                'default': '{% verbatim %}{{ visit.display_title }}{% endverbatim %}',
            },
            'ofv1': {
                'text': '{% trans "Ø/F værdi 1" %}',
                'help': "1 = Moderne bioteknologi; dyrlæger, dyreforsøg og dyrevelfærd\n" +
                        "2 = Gensplejsning og planteforædling\n" +
                        "3 = Adfærd og adfærdsproblemer hos landbrugs- og forsøgsdyr\n" +
                        "6 = Recirkulering af næringsstoffer fra by til land - et skridt på vejen mod bæredygtige samfund\n" +
                        "8 = Er landbrugspolitikken i USA til for landmændenes eller politikernes skyld?\n" +
                        "9 = Antibiotikumresistens hos bakterier"
            },
            'ofn2': {
                'text': '{% trans "2. Øvelse/foredrag navn" %}'
            },
            'ofv2': {
                'text': '{% trans "Ø/F værdi 2" %}',
                'help': "1 = Moderne bioteknologi; dyrlæger, dyreforsøg og dyrevelfærd\n" +
                        "2 = Gensplejsning og planteforædling\n" +
                        "3 = Adfærd og adfærdsproblemer hos landbrugs- og forsøgsdyr\n" +
                        "6 = Recirkulering af næringsstoffer fra by til land - et skridt på vejen mod bæredygtige samfund\n" +
                        "8 = Er landbrugspolitikken i USA til for landmændenes eller politikernes skyld?\n" +
                        "9 = Antibiotikumresistens hos bakterier"
            },
            'agn': {
                'text': '{% trans "Ansvarligguide navn" %}',
                'default': '{% verbatim %}{{ guest.get_full_name }}{% endverbatim %}'
            },
            'agv': {
                'text': '{% trans "Ansvarlig guide" %}',
                'help': "2 = Agnete Solvej Poulsen\n" +
                        "3 = Anders Kruse\n" +
                        "4 = Andreas Eske Johansen Sørensen\n" +
                        "5 = Anine Svendsen Kimer\n" +
                        "6 = Camilla Buch Vang Hansen\n" +
                        "8 = Guide Kristina Mejer\n" +
                        "9 = Jeppe Baden\n" +
                        "10 = Pernille Vestergaard Jensen"
            },
            'rgn': {
                'text': '{% trans "Rundvisningsguide(r) navn" %}',
                'default': '{% verbatim %}{{ guest.lastname }} {{ guest.firstname }}{% endverbatim %}'
            },
            'rgv': {
                'text': '{% trans "Rundvisningsguide(r) navn" %}'
            },
            'kt': {
                'text': '{% trans "Klassetrin" %}',
                'help': "14 = Børnehave\n" +
                        "0 = 0. klasse\n" +
                        "1 = 1. klasse\n" +
                        "2 = 2. klasse\n" +
                        "3 = 3. klasse\n" +
                        "4 = 4. klasse\n" +
                        "5 = 5. klasse\n" +
                        "6 = 6. klasse\n" +
                        "7 = 7. klasse\n" +
                        "8 = 8. klasse\n" +
                        "9 = 9. klasse\n" +
                        "10 = 10. klasse\n" +
                        "11 = 1. G\n" +
                        "12 = 2. G\n" +
                        "13 = 3. G\n" +
                        "15 = Speciel\n" +
                        "16 = Andet"
            },
            'opl': {
                'text': '{% trans "Oplæg" %}',
                'help': '1 = Ja\n'+
                        '2 = Nej'
            },
            'rv': {
                'text': '{% trans "Rundvisning" %}',
                'help': '1 = Ja\n'+
                        '2 = Nej'
            }
        };
        var keyOrder = ['key', 'tname', 'email', 'uname', 'uv', 'of', 'oename', 'bd', 'ofn1', 'ofv1', 'ofn2', 'ofv2', 'agn', 'agv', 'rgn', 'rgv', 'kt', 'opl', 'rv'];


        var fieldContainer = $("#fieldContainer"),
            extraFields = $("#extrafields"),
            defaults = {};

        // Generate field rows
        for (var i=0; i<keyOrder.length; i++) {
            var key = keyOrder[i];
            var fieldDefinition = formDefinition[key];
            var fieldRowHtml = [], j = 0;
            var defaultValue = 'default' in fieldDefinition ? fieldDefinition['default'] : null,
                enabled = true,
                value = key in original ? (original[key]) : (defaultValue !== null ? defaultValue : ''),
                text = fieldDefinition['text'] || '';

            fieldRowHtml[j++] = '<div class="row form-group">';

            fieldRowHtml[j++] = '<div class="col-sm-1">';
            fieldRowHtml[j++] = '<input type="checkbox" id="enable_' + key + '" ' + (enabled ? 'checked="checked"' : '') + '/>';
            fieldRowHtml[j++] = '</div>';

            fieldRowHtml[j++] = '<div class="col-sm-2">';
            fieldRowHtml[j++] = '<label class="control-label" for="field_' + key + '">' + text + '</label>';
            fieldRowHtml[j++] = '</div>';

            fieldRowHtml[j++] = '<div class="col-sm-1">';
            //fieldRowHtml[j++] = '[' + key + ']';
            if ('help' in fieldDefinition) {
                fieldRowHtml[j++] = '<span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-placement="right" title="';
                fieldRowHtml[j++] = fieldDefinition['help'].replace(/\n/g, "<br/>");
                fieldRowHtml[j++] = '"></span>';
            }
            fieldRowHtml[j++] = '</div>';

            fieldRowHtml[j++] = '<div class="col-sm-5">';
            fieldRowHtml[j++] = '<input class="form-control input-sm" type="text" id="field_' + key + '"/>';
            fieldRowHtml[j++] = '</div>';

            if (defaultValue !== null) {
                fieldRowHtml[j++] = '<div class="col-sm-3">';
                fieldRowHtml[j++] = '<button type="button" class="btn btn-default btn-sm setdefault" id="default_' + key + '" data-key="' + key + '">' + defaultLabel + '</button>'
                fieldRowHtml[j++] = '</div>';
            }

            fieldRowHtml[j++] = '</div>';

            fieldContainer.append($(fieldRowHtml.join("")));

            fieldContainer.find("#field_"+key).val(value);

            if (defaultValue !== null) {
                defaults[key] = defaultValue;
            }
        }

        for (var i=0; i<presets.length; i++) {
            var preset = presets[i];
            var option = $('<option value="'+i+'">'+preset['label']+'</option>');
            presetSelector.append(option);
        }

        var updateSelect = function(){
            var value = presetSelector.val(),
                keys = presets[value].keys,
                elements = $();
            for (var i=0; i<keys.length; i++) {
                elements = elements.add($("#enable_"+keys[i]));
            }
            var checkboxes = fieldContainer.find("input[type=checkbox]");
            checkboxes.prop("checked", false);
            checkboxes.filter(elements).prop("checked", true);
            checkboxes.each(checkboxUpdate);
            updateUrl();
        };
        presetSelector.on("change", updateSelect);

        var checkboxUpdate = function() {
            var $this = $(this);
            var key = $this.attr("id").substring("enable_".length);
            var enabled = $this.is(":checked");
            $("#field_"+key+", #default_"+key).prop("disabled", !enabled);
        };
        $("input[type=checkbox]").change(checkboxUpdate);
        $("input[type=checkbox]").each(checkboxUpdate);

        {% verbatim %}
        var tagStart = new RegExp("^{{");
        {% endverbatim %}

        var updateUrl = function() {
            var params = [];
            for (var k = 0; k < keyOrder.length; k++) {
                var key = keyOrder[k];
                var fieldDefinition = formDefinition[key];
                if ($("#enable_"+key).is(":checked")) {
                    params.push({
                        'key': key,
                        'value': $("#field_" + key).val().trim()
                    });
                }
            }
            extraParams = extraFields.val().split(/[\n&]/);
            for (var l=0; l<extraParams.length; l++) {
                var extraParam = extraParams[l].trim();
                if (extraParam.length > 0) {
                    var item = {};
                    var s = extraParam.split("=", 2);
                    if (s.length >= 1) {
                        item['key'] = s[0].trim();
                    }
                    if (s.length === 2) {
                        item['value'] = s[1].trim()
                    }
                    params.push(item);
                }
            }
            var resultParams = [];
            for (var m=0; m<params.length; m++) {
                var value = params[m]['value'] || "";
                if (tagStart.test(value)) {
                    value = value.replace(/[}\s]*$/, " }}");
                }
                resultParams[m] = params[m]['key'] + "=" + value;
            }
            urlField.val(urlBase + "?" + resultParams.join("&"));
        };
        fieldContainer.find("input").on("input", updateUrl);
        extraFields.on("input", updateUrl);

        fieldContainer.find(".setdefault").on('click', function() {
            var key = $(this).attr('data-key');
            fieldContainer.find("#field_"+key).val(defaults[key]);
            updateUrl();
        });

        updateSelect();
        //updateUrl();
    </script>
    <script type="text/javascript">
        $(function () {
            $('[data-toggle="tooltip"]').tooltip({
                html: true
            });
        })
    </script>
{% endblock %}
