{% extends "index.html" %}
{% load staticfiles %}
{% load booking_tags %}
{% load i18n %}

{% block htmltitle %} - {% trans 'overblik over evalueringer' %}{% endblock %}

{% block content %}

    {% include 'common/breadcrumbrow.html' %}

    <h1>{% if object.pk %}{% trans "Rediger evaluering" %}{% else %}{% trans "Opret evaluering" %}{% endif %}</h1>

    <form id="evaluationform" action="" class="form-horizontal clearfix" method="post" enctype="multipart/form-data">

        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="row form-group">
            <div class="col-sm-1"></div>
            <div class="col-sm-1">
                <label for="presetSelector">{% trans 'Type:' %}</label>
            </div>
            <div class="col-sm-7">
                <select id="presetSelector" class="form-control input-sm"></select>
            </div>
        </div>

        <div id="fieldContainer"></div>
        <div class="row form-group">
            <div class="col-sm-2">
                <label for="extrafields">{% trans 'Ekstra felter:' %}</label>
            </div>
            <div class="col-sm-7">
                <textarea id="extrafields" style="width:100%; min-height:8em; resize:none"></textarea>
            </div>
            <div class="col-sm-3">
                {% trans 'Ekstra URL-parametre, f.eks.:' %}<br>
                <code>foo=bar</code><br/>
                <code>version=42</code><br/>
                {% trans 'Linjeskift erstattes af & i resultatet' %}
            </div>
        </div>

        {% include 'common/fields/generic_field.html' with field=form.url %}
        {% include 'common/save_cancel.html' %}
    </form>

{% endblock %}

{% block extra_scripts %}
    <script type="text/javascript">

        var urlField = $("#{{ form.url.id_for_label }}");
        var urlBase = "http://survey-xact.dk/LinkCollector";
        var defaultLabel = "{% trans 'Brug standard' %}";
        var presetSelector = $("#presetSelector");
        var original = {};
        try {
            var originalFields = urlField.val().split("?", 2)[1].split("&");
            for (var i=0; i<originalFields.length; i++) {
                var v = originalFields[i].split("=", 2);
                original[v[0]] = v[1];
            }
        } catch (e) {}

        var presets = [
            {
                'label': '{% trans "Skoletjenesten" %}',
                'keys': ['key', 'tname', 'email', 'uv', 'uname', 'of', 'oename', 'bd', 'kt']
            },
            {
                'label': '{% trans "Gymnasieelever" %}',
                'keys': ['key', 'bd', 'ofn1', 'ofn2', 'ofv1', 'ofv2', 'agn', 'agv', 'rgn', 'opl', 'rv', 'kt']
            },
            {
                'label': '{% trans "GymnasielÃ¦rere" %}',
                'keys': ['key', 'tname', 'email', 'bd', 'ofn1', 'ofn2', 'ofv1', 'ofv2', 'agn', 'agv', 'rgn', 'opl', 'rv', 'kt']
            }
        ];
        {% verbatim %}
        var formDefinition = [
            {'key': 'key'},
            {'key': 'tname', 'default': '{{ guest.full_name }}'},
            {'key': 'uname', 'default': '{{ guest.full_name }}'},
            {'key': 'email', 'default': '{{ guest.email }}'},
            {'key': 'uv', 'default': '{{ visit.assigned_teachers.first.get_full_name|default:"" }}'},
            {'key': 'of'},
            {'key': 'oename', 'default': '{{ visit.display_title }}'},
            {'key': 'bd', 'default': '{{ visit.start_datetime|date:"j F" }}'},
            {'key': 'ofn1', 'default': '{{ visit.display_title }}'},
            {'key': 'ofv1'},
            {'key': 'ofv2'},
            {'key': 'ofn1'},
            {'key': 'ofn2'},
            {'key': 'agn', 'default': '{{ guest.get_full_name }}'},
            {'key': 'agv'},
            {'key': 'rgn', 'default': '{{ guest.lastname }} {{ guest.firstname }}'},
            {'key': 'rgv'},
            {'key': 'kt'},
            {'key': 'opl'},
            {'key': 'rv'}
        ];
        {% endverbatim %}

        var fieldContainer = $("#fieldContainer"),
            extraFields = $("#extrafields"),
            defaults = {};

        // Generate field rows
        for (var i=0; i<formDefinition.length; i++) {
            var fieldDefinition = formDefinition[i];
            var fieldRowHtml = [], j = 0;
            var key = fieldDefinition['key'],
                defaultValue = 'default' in fieldDefinition ? fieldDefinition['default'] : null,
                enabled = true,
                value = key in original ? (original[key]) : (defaultValue !== null ? defaultValue : '');

            fieldRowHtml[j++] = '<div class="row form-group">';

            fieldRowHtml[j++] = '<div class="col-sm-1">';
            fieldRowHtml[j++] = '<input type="checkbox" id="enable_' + key + '" ' + (enabled ? 'checked="checked"' : '') + '/>';
            fieldRowHtml[j++] = '</div>';

            fieldRowHtml[j++] = '<div class="col-sm-1">';
            fieldRowHtml[j++] = '<label class="control-label" for="field_' + key + '">' + key + ':</label>';
            fieldRowHtml[j++] = '</div>';

            fieldRowHtml[j++] = '<div class="col-sm-7">';
            fieldRowHtml[j++] = '<input class="form-control input-sm" type="text" id="field_' + key + '"/>';
            fieldRowHtml[j++] = '</div>';

            if (defaultValue !== null) {
                fieldRowHtml[j++] = '<div class="col-sm-3">';
                fieldRowHtml[j++] = '<button type="button" class="btn btn-default btn-sm setdefault" id="default_' + key + '" data-key="' + key + '">' + defaultLabel + '</button>'
                fieldRowHtml[j++] = '</div>';
            }

            fieldRowHtml[j++] = '</div>';

            fieldContainer.append($(fieldRowHtml.join("")));

            fieldContainer.find("#field_"+key).val(value);

            if (defaultValue !== null) {
                defaults[key] = defaultValue;
            }
        }

        for (var i=0; i<presets.length; i++) {
            var preset = presets[i];
            var option = $('<option value="'+i+'">'+preset['label']+'</option>');
            presetSelector.append(option);
        }

        var updateSelect = function(){
            var value = presetSelector.val(),
                keys = presets[value].keys,
                elements = $();
            for (var i=0; i<keys.length; i++) {
                elements = elements.add($("#enable_"+keys[i]));
            }
            var checkboxes = fieldContainer.find("input[type=checkbox]");
            checkboxes.prop("checked", false);
            checkboxes.filter(elements).prop("checked", true);
            checkboxes.each(checkboxUpdate);
            updateUrl();
        };
        presetSelector.on("change", updateSelect);

        var checkboxUpdate = function() {
            var $this = $(this);
            var key = $this.attr("id").substring("enable_".length);
            var enabled = $this.is(":checked");
            $("#field_"+key+", #default_"+key).prop("disabled", !enabled);
        };
        $("input[type=checkbox]").change(checkboxUpdate);
        $("input[type=checkbox]").each(checkboxUpdate);

        {% verbatim %}
        var tagStart = new RegExp("^{{");
        {% endverbatim %}

        var updateUrl = function() {
            var params = [];
            for (var k = 0; k < formDefinition.length; k++) {
                var fieldDefinition = formDefinition[k],
                    key = fieldDefinition['key'];
                if ($("#enable_"+key).is(":checked")) {
                    params.push({
                        'key': key,
                        'value': $("#field_" + key).val().trim()
                    });
                }
            }
            extraParams = extraFields.val().split(/[\n&]/);
            for (var l=0; l<extraParams.length; l++) {
                var extraParam = extraParams[l].trim();
                if (extraParam.length > 0) {
                    var item = {};
                    var s = extraParam.split("=", 2);
                    if (s.length >= 1) {
                        item['key'] = s[0].trim();
                    }
                    if (s.length === 2) {
                        item['value'] = s[1].trim()
                    }
                    params.push(item);
                }
            }
            var resultParams = [];
            for (var m=0; m<params.length; m++) {
                var value = params[m]['value'] || "";
                if (tagStart.test(value)) {
                    value = value.replace(/[}\s]*$/, " }}");
                }
                resultParams[m] = params[m]['key'] + "=" + value;
            }
            urlField.val(urlBase + "?" + resultParams.join("&"));
        };
        fieldContainer.find("input").on("input", updateUrl);
        extraFields.on("input", updateUrl);

        fieldContainer.find(".setdefault").on('click', function() {
            var key = $(this).attr('data-key');
            fieldContainer.find("#field_"+key).val(defaults[key]);
            updateUrl();
        });

        updateSelect();
        //updateUrl();
    </script>
{% endblock %}
