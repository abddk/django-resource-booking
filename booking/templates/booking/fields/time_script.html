{% load booking_tags %}
{% load i18n %}

{% if bookerform.attendee_count and bookingform.visit %}
    <script type="text/javascript">
        <!--
        (function(){
            {% autoescape off %}
                // How many idle spots are available on each visit
                var visitAvailable = {{ times_available | jsonify }},
            {% endautoescape %}
            visitSelect = $("#{{ bookingform.eventtime.id_for_label }}"),
            attendeeField = $("#{{ bookerform.attendee_count.id_for_label }}"),
            existingMax = attendeeField.attr("max"),
            submitbutton = $("#submitbutton");
            $("#waitinglist_warning").hide();
        
            if (visitSelect.length && attendeeField.length) {
                var updateVisit = function() {
                    var visit = visitAvailable[visitSelect.val()];
                    if (visit !== null) {
                        attendeeField.attr("max", Math.min(Math.max(visit.available, visit.waitinglist), existingMax));
                        attendeeField.trigger('change');
                        if (visit.available < existingMax) {
                            attendeeField.attr("min", 1);
                        }
                    }
                };

                var updateAttendees = function() {
                    var visit = visitAvailable[visitSelect.val()];
                    if (visit !== null) {
                        var doWaitingList = attendeeField.val() > visit.available && attendeeField.val() <= visit.waitinglist;
                        submitbutton.text(doWaitingList ? "{% trans 'Tilmeld til venteliste!' %}" : "{% trans 'Tilmeld!' %}");
                        $("#waitinglist_warning").toggle(doWaitingList);
                    }
                };

                visitSelect.change(updateVisit);
                attendeeField.change(updateAttendees);
                attendeeField.keyup(updateAttendees);
                updateVisit();
            }
        })();
        //-->
    </script>
{% endif %}