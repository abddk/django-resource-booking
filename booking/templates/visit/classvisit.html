{% extends 'index.html' %}
{% load i18n %}
{% load staticfiles %}
{% load booking_tags %}

{% block head %}
    <link href="{% static 'recurrence/css/recurrence.css' %}" type="text/css" media="all" rel="stylesheet" />
    <script>
        // @TODO: Remove this hack when django-recurrence internationalization detection
        // is fixed or when i18n support is added to Knock
        if (!pgettext) {
            function pgettext(ignore, t) {
                return gettext(t);
            }
        }
    </script>
    <script type="text/javascript" src="{% static 'js/recurrence.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/recurrence-widget.js' %}"></script>
{% endblock %}

{% block content %}
    CLASS VISIT
    <div class="divider"></div>
    <div class="row form-group">
        <div class="col-sm-8">
            <h1>{% if object.pk %}{% trans "Rediger tilbud" %}{% else %}{% trans "Nyt tilbud" %}{% endif %}</h1>
        </div>
        <div class="col-sm-4 text-right">
            <a href="#" class="btn btn-default btn-sm openall">{% trans "Udvid alle felter" %}</a> <a href="#" class="btn btn-default btn-sm closeall">{% trans "Luk alle felter" %}</a>
        </div>
    </div>
    <hr/>
    <form action="" class="form-horizontal clearfix" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {{ form.non_field_errors }}

        <div id="accordion" class="panel-group" aria-multiselectable="true" role="tablist">

            {% include 'visit/type.html' %}

            <div class="panel panel-default">
                <div id="headingCategory" class="panel-heading" role="tab">
                    <h4 class="panel-title">
                        <a class="" aria-controls="collapseTitel" aria-expanded="false" href="#collapseTitel" data-parent="#accordion" data-toggle="collapse" role="button">{% trans "Titel" %}</a><span class="caret"></span>
                    </h4>
                </div>
                <div id="collapseTitel" class="panel-collapse collapse
                {% if not object.pk or form.title.errors or form.title.errors %}in{% endif %}
                " aria-labelledby="headingCategory" role="tabpanel" aria-expanded="true" style="">
                    <div class="panel-body">
                        <div class="row form-group">
                            <div>
                                {{ form.title.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label class="{{ form.title.css_classes }}" for="{{ form.title.id_for_label }}">{{ form.title.label }}:</label>
                            </div>
                            <div class="col-sm-10">
                                {{ form.title }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="panel panel-default">
                <div id="headingDescription" class="panel-heading" role="tab">
                    <h4 class="panel-title">
                        <a aria-controls="collapseDescription" aria-expanded="false" href="#collapseDescription" data-parent="#accordion" data-toggle="collapse" role="button">{% trans "Beskrivelse" %}</a><span class="caret"></span>
                    </h4>
                </div>
                <div id="collapseDescription" class="panel-collapse collapse
                {% if not form.errors or form.teaser.errors or form.description.errors or form.price.errors %}in{% endif %}
                " aria-labelledby="headingDescription" role="tabpanel">
                    <div class="panel-body">
                        <div class="row form-group">
                            <div>
                                {{ form.teaser.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label class="{{ form.teaser.css_classes }}" for="{{ form.teaser.id_for_label }}">{{ form.teaser.label }}:</label>
                            </div>
                            <div class="col-sm-10">
                                {{ form.teaser }}
                            </div>
                        </div>
                        <div class="row form-group">
                            <div>
                                {{ form.description.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label class="{{ form.description.css_classes }}" for="{{ form.description.id_for_label }}">{{ form.description.label }}:</label>
                            </div>
                            <div class="col-sm-10">
                                {{ form.description }}
                            </div>
                        </div>
                        <div class="row form-group">
                            <div>
                                {{ form.price.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label class="{{ form.price.css_classes }}" for="{{ form.price.id_for_label }}">{{ form.price.label }}:</label>
                            </div>
                            <div class="col-sm-10">
                                {{ form.price }}
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col-sm-2">
                                <label>{% trans "Vedhæftede filer" %}:</label>
                            </div>
                            <div class="col-sm-10">
                                {% if fileformset.studymaterials %}
                                <ul>
                                {% for material in fileformset.studymaterials %}
                                    <li>
                                        <a href="{{ MEDIA_URL }}{{ material.file.url }}">{{ material.file.name | upload_name_strip_path }}</a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endif %}
                                {{ fileformset.management_form }}
                                <div id="attachFileFields">
                                {% for fileform in fileformset %}
                                    <div class="fileupload">
                                        {{ fileform.file }}
                                    </div>
                                {% endfor %}
                                </div>
                                <a id="attachAddFileField">{% trans "Tilføj ny fil" %}</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel panel-default">
                <div id="headingAudience" class="panel-heading" role="tab">
                    <h4 class="panel-title">
                        <a class="" aria-controls="collapseAudience" aria-expanded="false" href="#collapseAudience" data-parent="#accordion" data-toggle="collapse" role="button">{% trans "Målgruppe" %}</a><span class="caret"></span>
                    </h4>
                </div>
                <div id="collapseAudience" class="panel-collapse collapse
                    {% if not object.pk or form.audience.errors or form.institution_level.errors or form.topics.errors or form.level.errors or form.class_level_min.errors or form.class_level_max.errors or form.minimum_number_of_visitors.errors or form.maximum_number_of_visitors.errors or form.subjects.errors %}in{% endif %}
                    " aria-labelledby="headingAudience" role="tabpanel" aria-expanded="true" style="">
                    <div class="panel-body">
                        <div class="row form-group">
                            <div>
                                {{ form.audience.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label class="{{ form.level.css_classes }}" for="{{ form.audience.id_for_label }}">{{ form.audience.label }}:</label>
                            </div>
                            <div class="col-sm-10">
                                {{ form.audience }}
                            </div>
                        </div>

                        <div class="row form-group">
                            <div>
                                {{ form.institution_level.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label class="{{ form.institution_level.css_classes }}" for="{{ form.institution_level.id_for_label }}">{{ form.institution_level.label }}:</label>
                            </div>
                            <div class="col-sm-10">
                                {{ form.institution_level }}
                            </div>
                        </div>
                        <!-- <div class="row form-group">
                            <div>{{ form.topics.errors }}</div>
                            <div class="col-sm-2">
                            <label for="{{ form.topics.id_for_label }}">{{ form.topics.label }}:</label>
                            </div>
                            <div class="col-sm-10">
                            {{ form.topics }}
                            </div>
                        </div> -->

                        <div class="institution_level_dependent" data-display-value="1">
                            <div class="row form-group">
                                <div>
                                    {{ form.level.errors }}
                                </div>
                                <div class="col-sm-2">
                                    <label class="{{ form.level.css_classes }}" for="{{ form.level.id_for_label }}">{{ form.level.label }}:</label>
                                </div>
                                <div class="col-sm-10">
                                    {{ form.level }}
                                </div>
                            </div>
                        </div>
                        <div class="institution_level_dependent" data-display-value="2">
                            <div class="row form-group">
                                <div>
                                    {{ form.class_level_min.errors }}
                                </div>
                                <div class="col-sm-2">
                                    <label class="{{ form.class_level.css_classes }}" for="{{ form.class_level_min.id_for_label }}">{{ form.class_level_min.label }}:</label>
                                </div>
                                <div class="col-sm-10">
                                    {{ form.class_level_min }}
                                </div>
                            </div>
                            <div class="row form-group">
                                <div>
                                    {{ form.class_level_max.errors }}
                                </div>
                                <div class="col-sm-2">
                                    <label class="{{ form.class_level_max.css_classes }}" for="{{ form.class_level_max.id_for_label }}">{{ form.class_level_max.label }}:</label>
                                </div>
                                <div class="col-sm-10">
                                    {{ form.class_level_max }}
                                </div>
                            </div>
                        </div>
                        <div class="institution_level_dependent">
                            <div class="row form-group">
                                <div>
                                    {{ form.subjects.errors }}
                                </div>
                                <div class="col-sm-2">
                                    <label class="{{ form.subjects.css_classes }}" for="{{ form.subjects.id_for_label }}">{{ form.subjects.label }}:</label>
                                </div>
                                <div class="col-sm-10">
                                    {{ form.subjects }}
                                </div>
                            </div>
                        </div>
                        <div class="row form-group">
                            <div>
                                {{ form.minimum_number_of_visitors.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label class="{{ form.minimum_number_of_visitors.css_classes }}" for="{{ form.minimum_number_of_visitors.id_for_label }}">{{ form.minimum_number_of_visitors.label }}:</label>
                            </div>
                            <div class="col-sm-10">
                                {{ form.minimum_number_of_visitors }}
                            </div>
                        </div>
                        <div class="row form-group">
                            <div>
                                {{ form.maximum_number_of_visitors.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label class="{{ form.maximum_number_of_visitors.css_classes }}" for="{{ form.maximum_number_of_visitors.id_for_label }}">{{ form.maximum_number_of_visitors.label }}:</label>
                            </div>
                            <div class="col-sm-10">
                                {{ form.maximum_number_of_visitors }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% include 'visit/time.html' %}

            {% include 'visit/locality.html' %}

            {% include 'visit/contact.html' %}
            
            <div class="panel panel-default">
                <div id="headingInternal" class="panel-heading" role="tab">
                    <h4 class="panel-title">
                        <a class="" aria-controls="collapseInternal" aria-expanded="true" href="#collapseInternal" data-parent="#accordion" data-toggle="collapse" role="button">{% trans "Interne oplysninger" %}</a><span class="caret"></span>
                    </h4>
                </div>
                <div id="collapseInternal" class="panel-collapse collapse {% if form.enabled.errors or form.contact_persons.errors %}in{% endif %} " aria-labelledby="headingContact" role="tabpanel" aria-expanded="true" style="">
                    <div class="panel-body">
                        <div class="row form-group">  
                            <div>{{ form.preparation_time.errors }}</div>
                            <div class="col-sm-2">
                            <label for="{{ form.preparation_time.id_for_label }}">{{ form.preparation_time.label }}:</label>
                                </div>
                                <div class="col-sm-2">
                            {{ form.preparation_time }}
                        </div>
                        </div>
                        <div class="row form-group">  
                            <div>{{ form.comment.errors }}</div>
                            <div class="col-sm-2">
                            <label for="{{ form.comment.id_for_label }}">{{ form.comment.label }}:</label>
                                </div>
                                <div class="col-sm-10">
                            {{ form.comment }}
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% include 'common/save_cancel.html' %}
        <div class="divider"></div>
    </form>

{% endblock %}

{% block extra_scripts %}
    
    {{ form.media }}
    <script type="text/javascript" src="{% static 'thirdparty/bootstrap-datetime-picker/js/bootstrap-datetimepicker.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/formutil.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/formset-row.js' %}"></script>

    <script type="text/javascript"><!--

        $(function(){
            $("#attachAddFileField").click(function(){
                formset.addRow(
                        $("#{{ fileformset.management_form.TOTAL_FORMS.id_for_label }}"),
                        $("#{{ fileformset.management_form.MAX_NUM_FORMS.id_for_label }}"),
                        $(".fileupload").first(),
                        $("#attachFileFields")
                );
                return false;
            });
        });

        $(function(){
            var select = $("#{{ form.institution_level.id_for_label }}");
            var changeDisplay = function(){
                var value = select.val();
                $(".institution_level_dependent").each(function() {
                    var attr = $(this).attr("data-display-value") || 0xFFFFFF;
                    console.log(attr, value, parseInt(value), parseInt(attr))
                    if (parseInt(value) & parseInt(attr)) {
                        $(this).show()
                    } else {
                        $(this).hide()
                    }
                })
            };
            select.change(changeDisplay);
            changeDisplay();
            // Toggle arrows
            $('.collapse').on('show.bs.collapse', function() {
            $(this).prev().find(".caret").addClass("caret-up");
            });
            $('.collapse').on('hide.bs.collapse', function() {
                $(this).prev().find(".caret").removeClass("caret-up");
            });
            $('.closeall').click(function(){
              $('.panel-collapse.in').collapse('hide');
            });
            $('.openall').click(function(){
              $('.panel-collapse:not(".in")').collapse('show');
            });
        });

        $("#id_recurrences").on("change", function() {
            $.ajax({
                url : "/jsapi/rrulestr",
                type : "POST",
                data : {
                    'rrulestr': $(this).val(),
                    'start_times': $('#id_time').val() === "" ? "00:00" : $('#id_time').val(),
                    'duration': $('#id_duration').val(),
                    'visit_id': $('#existing-recurrence-dates').data('visitId'),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },

                success : function(json) {
                    var list = $('#recurrence-dates');

                    list.empty();

                    var items = [];

                    $.each(json, function(i, item) {

                        items.push('<li><input type="checkbox" name="occurrences" value="' + item + '"/>' + item + '</li>');

                    });  // close each()

                    list.append( items.join('') );
                },

                error : function(xhr,errmsg,err) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }
            });
        });
        var addTimeField = function(){
            var timeDiv = $(".time-select>div").clone(true,true);
            timeDiv.appendTo($(".time-container"));
            $(".remove-button").prop('disabled', false);
        };
        $(".plus-button").click(addTimeField);
        $(".remove-button").click(function(){
            $(this).parent().remove();
        });
        $(".start-time").on('change', function(){
            var value = [];
            $(".start-time").each(function(){
                value.push($(this).val());
            });
            $('#id_time').val(value.join(','));
        });
        (function(select_id) {
            var type_map = {
                "Gymnasie": 1,
                "Grundskole": 2,
                "Begge": 3
            };
            $(function() {
                $(select_id).on("change", function() {
                    var val = parseInt($(this).val()) || 0xFFFFFF;
                    $('input[name=subjects]').each(function() {
                        var txt = $(this).parent().text().match(
                            /\((Gymnasie|Grundskole|Begge)\)/
                        );
                        if (txt && txt.length) {
                            txt = txt[1];
                        }
                        v = type_map[txt || ''];
                        if (v && parseInt(v) & val) {
                            $(this).parent().show();
                            if ($(this).attr("data-prev-selected")) {
                                $(this).removeAttr("data-prev-selected");
                                $(this).prop("checked", true);
                            }
                        } else {
                            $(this).parent().hide();
                            if ($(this).is(":checked")) {
                                $(this).prop("checked", false);
                                $(this).attr("data-prev-selected", "yes");
                            }
                        }
                    });
                }).trigger("change");
            });
        })('#{{form.institution_level.id_for_label }}')
    //--></script>
    
{% endblock %}
