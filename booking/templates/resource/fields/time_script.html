<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.5.0/js/bootstrap-datepicker.min.js"></script>
<script src="/static/js/bootstrap-datepicker.da.min.js"></script>
<script src="/static/js/picker.time.js"></script>
<script src="/static/js/rrule.js"></script>

<script type="text/javascript"><!--
    $(function(){
        
        var currentDatesEl = $("#existing-recurrence-dates");
        var currentDates = [];
        
        // Push exsisting dates written out in html into currentDates for processing
        currentDatesEl.find('li').each(function() {
            var dateparts = $(this).attr('data-date').split(/[^0-9]/i);
            var d = new Date();
            d.setDate(dateparts[0]);
            d.setMonth(dateparts[1] - 1);
            d.setFullYear(dateparts[2]);
            d.setHours(dateparts[3]);
            d.setMinutes(dateparts[4]);
            currentDates.push({
                date: d,
                istimeset: true,
                isbooked: false
            });
            UpdateDateList();
        });
        
        
        function getFormattedPartTime(partTime){
            if ( partTime < 10 )
               return "0" + partTime;
            return partTime;
        };
        
        
        // Adding a date using Bootstrap datepicker 
        
        var datepick = $('#id_datepick').datepicker({
            language: 'da',
            format: 'dd-mm-yyyy',
            weekStart: 1,
            calendarWeeks: true,
            todayHighlight: true,
            startDate: 'Date',
            clearBtn: false,
            autoclose: true
        });
        
        datepick.on('changeDate', function(ev){
            var dateparts = $(this).val().split('-');
            var d = new Date();
            d.setDate(dateparts[0]);
            d.setMonth(dateparts[1] - 1);
            d.setFullYear(dateparts[2]);
            currentDates.push({
                date: d,
                istimeset: false,
                isbooked: false
            });
            UpdateDateList();
        });
        
        
        // Refresh avilable dates list
        
        function UpdateDateList() {
            
            
            // Sort the existing list items by date
            
            currentDates.sort( function(a,b){ return a.date > b.date } );
            
            
            // Display date entry in list
            
            currentDatesEl.html('');
            for (var d in currentDates) {
                var t = currentDates[d];
                var datedate = getFormattedPartTime(t.date.getDate()) + '-' + getFormattedPartTime(t.date.getMonth() + 1) + '-' + t.date.getFullYear();
                var datetime = '';
                if (t.istimeset) {
                    datetime = ' value="' + getFormattedPartTime(t.date.getHours()) + ':' + getFormattedPartTime(t.date.getMinutes()) + '"';
                };
                currentDatesEl.append('<li id="' + d + '" data-date="' + datedate + '">' + datedate + ' <input class="btn-add-time timepick" type="text" name="timepick" placeholder="TilfÃ¸j tid"' + datetime + '><button type="button" class="btn-rm-date">x</button></li>');
            };
            
            
            // Update hidden input field
            
            var arr = [];
            for (var d in currentDates) {
                var dt = currentDates[d];
                var datetime = getFormattedPartTime(dt.date.getDate()) + '-' + getFormattedPartTime(dt.date.getMonth() + 1) + '-' + dt.date.getFullYear();
                if (dt.istimeset) {
                    datetime = datetime + ' ' + getFormattedPartTime(dt.date.getHours()) + ':' + getFormattedPartTime(dt.date.getMinutes())
                };
                arr.push(datetime);
            };
            $("#occurrences").val(arr);
            
            
            // Check if it's relevant to show bulk manipulation buttons
            if (currentDates.length > 0) {
                $('.modify-datetime').addClass('modify-datetime-show');
            
                
                // Update dates list manipulations buttons
        
                currentDatesEl.find('li').each(function() {
                    
                    var elID = parseInt( $(this).attr('id') );
                    var el = $(this);
                    
                    // Remove date-time
                    el.find('.btn-rm-date').on('click', function(ev) { 
                        ev.preventDefault();
                        el.detach();
                        currentDates.splice(elID, 1);
                        UpdateDateList();
                    });
                    
                    // Adding/updating time using Pickadate.js
                    el.find('.btn-add-time').on('click', function(ev) { 
                        ev.preventDefault();
                        var tinput = $(this);
                        var timepick = tinput.pickatime({
                            format: 'H:i',
                            clear: 'Nulstil',
                            container: el,
                            onClose: function() {
                                if (tinput.val() != '') {
                                    var tparts = tinput.val().split(':');
                                    currentDates[elID].date.setHours(tparts[0]);
                                    currentDates[elID].date.setMinutes(tparts[1]);
                                    currentDates[elID].istimeset = true;
                                } else {
                                    currentDates[elID].istimeset = false;
                                };
                                UpdateDateList();
                            }
                        });
                    });
                    
                });
                
            } else {
                $('.modify-datetime').removeClass('modify-datetime-show');
            };
            
        };
        
        
        // Setting time for all available dates
        
        $('.btn-add-time-all').on('click', function(ev) {
            ev.preventDefault();
            var inputEl = $('.add-time-all');
            var timepick = inputEl.pickatime({
                format: 'H:i',
                clear: 'Nulstil',
                onClose: function() {
                    if (inputEl.val() != '') {
                        var tparts = inputEl.val().split(':');
                        for (var i in currentDates) {
                            currentDates[i].date.setHours(tparts[0]);
                            currentDates[i].date.setMinutes(tparts[1]);
                            currentDates[i].istimeset = true;
                        };
                    } else {
                        for (var i in currentDates) {
                            currentDates[i].istimeset = false;
                        };
                    };
                    inputEl.val('');
                    UpdateDateList();
                }
            });
        });
        
        
        // Remove all available dates
        
        $('.btn-rm-date-all').on('click', function(ev) {
            ev.preventDefault();
            currentDates = [];
            currentDatesEl.html('');
            UpdateDateList();
        });
        
        
        
        // =============================================================================
        // Adding several dates using RRule.js
        // =============================================================================
         
        var modalEl = $('#rruleModal');
            
        var rule = new RRule({
            freq: RRule.WEEKLY,
            interval: 1,
            count: 10
        });
        
        var datepick = $('input[name="until"]:first').datepicker({
            language: 'da',
            format: 'dd-mm-yyyy',
            weekStart: 1,
            calendarWeeks: true,
            todayHighlight: true,
            startDate: 'Date',
            clearBtn: false,
            autoclose: true
        });
        
        
        // RRule update
        
        var updateRRDates = function() {
            rule = new RRule(rule.options);
            $('#rrule-text').html( rule.toText() );
            var outputEl = $('.rrule-datelist');
            outputEl.html('');
            for (var d in rule.all()) {
                outputEl.append('<li>' + rule.all()[d].toLocaleDateString() + '</li>');
            };
        };
        
        updateRRDates();
        
        
        // RRule input methods
        
        datepick.datepicker().on('hide', function(ev) {
            var dparts = $(this).val().split('-');
            var d = new Date();
            d.setDate(dparts[0]);
            d.setMonth(parseInt(dparts[1]) - 1);
            d.setFullYear(dparts[2]);
            rule.options.until = d;
            $('#input-count').val('');
            rule.options.count = undefined;
            updateRRDates();
        });
        
        $('#input-weekdays input').on('change', function(ev) {
            rule.options.byweekday = [];
            $('#input-weekdays input:checked').each(function(){
                console.log();
                switch ($(this).attr('name')) {
                    case 'RRule.MO':
                        rule.options.byweekday.push(RRule.MO);
                        break
                    case 'RRule.TU':
                        rule.options.byweekday.push(RRule.TU);
                        break
                    case 'RRule.WE':
                        rule.options.byweekday.push(RRule.WE);
                        break
                    case 'RRule.TH':
                        rule.options.byweekday.push(RRule.TH);
                        break
                    case 'RRule.FR':
                        rule.options.byweekday.push(RRule.FR);
                        break
                    case 'RRule.SA':
                        rule.options.byweekday.push(RRule.SA);
                        break
                    case 'RRule.SU':
                        rule.options.byweekday.push(RRule.SU);
                        break
                    default:
                        console.log('Improbable weekday');
                };
            });
            updateRRDates();
        });
        
        $('#input-count').on('blur', function(ev) {
            rule.options.count = $(this).val();
            $('#input-until').val('');
            rule.options.until = undefined;
            updateRRDates();
        });
    
        $('#btn-add-rrule-dates').on('click', function(ev) {
            ev.preventDefault();
            for (var i in rule.all()) {
                currentDates.push({
                    date: rule.all()[i],
                    istimeset: false,
                    isbooked: false
                });
            };
            UpdateDateList();
            modalEl.modal('hide');
        });
        
        
    });
    
//--></script>